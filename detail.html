<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<style>

	.chart rect {
	}

	.chart text {
	  fill: white;
	  font: 10px sans-serif;
	  text-anchor: end;
	}

	</style>
</head>
<body>


<svg class="chart"></svg>

 
<script src="https:////code.jquery.com/jquery-1.11.2.min.js"></script>
<script src="http://d3js.org/d3.v3.js"></script>
<script>

$( document ).ready(function() {

	$.ajax({
	    type :"GET",
	    url : 'data/parl41_sess2_vote2.xml',
	    success : function(dataXML){
	    	var data = [];
            $(dataXML).find('Vote').each(function(){
            	var sponsor = $(this).find('Sponsor').text();
            	var decision = $(this).find('Decision').text();
            	var bill = $(this).find('RelatedBill').attr('number');
                $(this).find('Participant').each(function(){
                    var vote = {
                    	name: $(this).find("Name").text(),
	                    first: $(this).find("FirstName").text(),
	                    last: $(this).find("LastName").text(),
	                    constituency: $(this).find("Constituency").text(),
	                    province: $(this).find("Province").text(),
	                    provinceCode: $(this).find("Province").attr('code'),
	                    party: $(this).find("Party").text(),
	                    yea: Number($(this).find("RecordedVote").find("Yea").text()),
	                    nay: Number($(this).find("RecordedVote").find("Nay").text()),
	                    paired: Number($(this).find("RecordedVote").find("Paired").text()),
	                    url: ''
                    };

                    // console.log(vote.voteNumber);
                    data.push(vote);
                });
            });

			// TODO put an example json here
			var partyVotes = data
				.reduce(function(prev, cur, ix, array) {
					var foo = prev;
					foo[cur.party] = foo[cur.party] || { yea:0, nay:0 };
					foo[cur.party]['yea'] += cur.yea;
					foo[cur.party]['nay'] += cur.nay;
					return foo;
				}, {});

			console.log(partyVotes);

			// don't bother trying to work out fractions, let d3.js handle that.
			// this is an imaginary number of seats (308 typically)
			var alternateParliament1 = [
				{party:'Bloc Québécois', seats: 50},
				{party:'Conservative', seats: 50},
				{party:'Conservative Independent', seats: 8},
				{party:'Green Party', seats: 50},
				{party:'Independent', seats: 50},
				{party:'Liberal', seats: 50},
				{party:'NDP', seats: 50}
			]

			// TODO flatten the array because all values are scaled the same way.
			// wait, maybe we can't flatten the array? things are still scaled based on party.

			function scaleVotes(realVotes, altParliament) {
				var result = {};
				// TODO calculate both totals. They will often not be the same, because
				// not everybody is in attendance.
				var realTotalVotes = realVotes
					.map(function(cur,ix,array){return cur.yea + cur.nay;})
					.reduce(function(cur,ix,array){return prev+cur;});
				var altTotalVotes = altParliament
					.map(function(cur,ix,array){return d.seats;})
					.reduce(function(prev,cur,ix,array){return prev+cur;});
				Object.keys(realVotes).forEach(function(key) {
					value = realVotes[key];
					var realPartyVotes = realVotes[key]['yea'] + realVotes[key]['nay'];
					//var fakePartyVotes = altParliament
					var partyScaleFactor = 
					result[key]['yea'] = realVotes[key]['yea'] * partyScaleFactor;
					result[key]['nay'] = realVotes[key]['nay'] * partyScaleFactor;
				});
			}

			var scaledVotes = scaleVotes(partyVotes, alternateParliament1);

			console.log(scaledVotes);

			var yeaVotes = data
				.map(function(cur, ix, array) {return cur.yea;})
				.reduce(function(prev, cur, ix, array) {return prev + cur;});

			var nayVotes = data
				.map(function(cur, ix, array) {return cur.nay;})
				.reduce(function(prev, cur, ix, array) {return prev + cur;});

			var pieData = [
				{vote: 'yea', count: yeaVotes, colour: 'green'},
				{vote: 'nay', count: nayVotes, colour: 'red'},
			];

			console.log(pieData);

			var width = 360;
	        var height = 360;
	        var radius = Math.min(width, height) / 2;

			var svg = d3.select('.chart')
			    .attr("width", width)
			    .attr("height", height)
			    .append('g')
				.attr('transform', 'translate(' + (width / 2) + ',' + (height / 2) + ')');

			var arc = d3.svg.arc()
				.outerRadius(radius);

	        var pie = d3.layout.pie()
				.value(function(d) { return d.count; })
				.sort(null);

	        var path = svg.selectAll('path')
				.data(pie(pieData))
				.enter()
				.append('path')
				.attr('d', arc)
				.attr('fill', function f(d,i){return d.data.colour;});

	    },
	    error : function(){
	        //error handler..
	    }
	});

});

</script>




</body>
</html>